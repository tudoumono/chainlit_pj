# Phase 4 動作確認チェックリスト

## Phase 4の概要
**基本的なチャット機能**：OpenAI Responses APIによる実際のAI応答機能の実装

## 新しく追加されたファイル
- `utils/response_handler.py` - OpenAI API管理モジュール
- `app.py` - Phase 4版に更新（v0.4.0）

## 起動前の確認

### 1. 環境チェック
```bash
uv run python check_env.py
```

### 2. APIキーの確認
`.env`ファイルに有効なOpenAI APIキーが設定されていることを確認

### 3. アプリケーション起動
```bash
uv run chainlit run app.py
```

## 機能テスト

### 1. 初期画面の確認
- [ ] Version: 0.4.0 (Phase 4) が表示される
- [ ] APIキーの状態が表示される
- [ ] 「準備完了！」メッセージが表示される（APIキー設定済みの場合）

### 2. 基本的なAI応答テスト

#### シンプルな会話
- [ ] 「こんにちは」と送信
- [ ] AIからの応答が返ってくる
- [ ] ストリーミングで文字が流れて表示される
- [ ] トークン使用量が表示される

#### 複雑な質問
- [ ] 「Pythonでフィボナッチ数列を生成する方法を教えて」と送信
- [ ] コード付きの詳細な応答が返ってくる
- [ ] フォーマットが正しく表示される

### 3. ストリーミング応答の確認
- [ ] 応答が一文字ずつ流れるように表示される
- [ ] 応答完了後に完全なメッセージが表示される
- [ ] エラーが発生しない

### 4. トークン使用量の確認
- [ ] 各応答後にトークン使用量が表示される
- [ ] セッション合計トークンが累積される
- [ ] 推定コストが表示される（`/stats`コマンド）

### 5. 新コマンドのテスト

#### `/model [モデル名]` - セッションモデル変更
- [ ] `/model gpt-4o` でモデル変更
- [ ] 変更後の応答が異なるモデルで生成される
- [ ] `/status` で現在のセッションモデルが表示される

#### `/system [プロンプト]` - システムプロンプト設定
- [ ] `/system あなたは関西弁で話すアシスタントです` を設定
- [ ] AIの応答が関西弁になる
- [ ] `/system` （引数なし）でクリアできる

### 6. 自動タイトル生成
- [ ] 新しいセッションで最初のメッセージを送信
- [ ] 自動的にセッションタイトルが生成される
- [ ] `/sessions` でタイトルが更新されている

### 7. メッセージ履歴の永続化
- [ ] 複数のメッセージをやり取り
- [ ] アプリを再起動
- [ ] `/sessions` で過去のセッションが表示される
- [ ] セッションに切り替えて会話を継続できる

### 8. エラーハンドリング

#### APIキー未設定
- [ ] APIキーなしでメッセージ送信
- [ ] エラーメッセージが表示される

#### 無効なAPIキー
- [ ] 無効なAPIキーを設定
- [ ] `/test` でエラーが検出される

#### ネットワークエラー
- [ ] インターネット接続を切断（テスト環境による）
- [ ] 適切なエラーメッセージが表示される

## パフォーマンステスト

### 長文の処理
- [ ] 長い質問を送信（例：「日本の歴史について詳しく教えて」）
- [ ] 長い応答が正しくストリーミング表示される
- [ ] メモリエラーが発生しない

### 連続メッセージ
- [ ] 素早く複数のメッセージを送信
- [ ] 各メッセージが正しく処理される
- [ ] 順序が保たれる

## コマンド一覧（Phase 4追加分）

| コマンド | 説明 | 例 |
|---------|------|-----|
| `/model` | セッションモデル変更 | `/model gpt-4o` |
| `/system` | システムプロンプト設定 | `/system 専門家として回答` |

## トラブルシューティング

### ストリーミングが動かない
```python
# response_handler.pyのストリーミング設定を確認
stream=True  # この設定が有効か確認
```

### トークンが表示されない
- OpenAI APIの応答にusage情報が含まれているか確認
- 一部のモデルではusage情報が異なる場合がある

### 自動タイトル生成が動かない
- 最初のメッセージ後に少し待つ
- エラーログを確認: `print(f"Error generating title: {e}")`

### ImportError: openai
```bash
# OpenAIライブラリを再インストール
uv pip install --upgrade openai
```

## Phase 4 完了基準

以下がすべて確認できたら完了：
- ✅ AIとの実際の会話ができる
- ✅ ストリーミング応答が動作する
- ✅ トークン使用量が追跡される
- ✅ システムプロンプトが機能する
- ✅ セッションごとのモデル変更ができる
- ✅ 自動タイトル生成が動作する
- ✅ メッセージ履歴が保存される
- ✅ エラーが適切に処理される

## 新機能の使用例

### カスタムアシスタントの作成
```
/system あなたはPythonの専門家です。コードには必ずコメントを付けてください。
/model gpt-4o
質問: デコレータの使い方を教えて
```

### 異なるモデルでの比較
```
/clear
/model gpt-4o-mini
質問: AIとは何ですか？
（応答を確認）

/clear
/model gpt-4o
質問: AIとは何ですか？
（応答の違いを比較）
```

### トークン使用量の確認
```
（何回か会話した後）
/stats
# トークン使用量と推定コストが表示される
```

## 次のステップ

Phase 5（セッション永続化の強化）に進む：
- previous_response_idの管理
- 会話の再開機能
- セッション検索機能
