# 多機能AIワークスペース - 開発順序計画書（Option B / Windows配布・Win/Linux開発）

更新日: 2025-09-09  
バージョン: 4.0  
前版: docs/archive/開発順序計画書.md に退避

## 概要
- 配布: Windowsのみ（NSIS/Portable）。
- 起動: Electron Main が Python を直接 spawn（dev: uv, prod: embedded Python）。
- 共通.env: 初回起動で `<userData>/.env` を生成（`.env.example`優先コピー／内蔵サンプルfallback）。
- 参照: docs/ADR/0001-electron-startup-architecture.md, docs/STRUCTURE_OPTION_B.md, docs/WINDOWS_PACKAGING.md

## フェーズ計画とUI確認ポイント

### Phase 1: 単一ウィンドウ切替 + UIスモーク（ここから実施）
- 目的: 単一ウィンドウ方式（トップレベルでChainlit表示）での起動・ログイン安定化を確認
- 前提: ルート`.env`に最低限のキー（OPENAI_API_KEY/DEFAULT_MODEL/CHAINLIT_AUTH_SECRET）を設定
- 手順（Windows/Linux共通）
  1) 依存インストール: `uv pip install -r requirements.in` / `npm i`
  2) 開発起動: `npm run dev`
  3) 設定画面表示（ヘルスチェック/ログフォルダを開く）
  4) 「チャットを開始」→ 同一ウィンドウで `http://localhost:8000` をトップレベル表示
  5) ログイン成功（第一者Cookie）→ チャットUI表示
  6) 「設定に戻る」で復帰、終了で8000/8001が解放される
- 受入基準
  - Electron内でのログイン成功（401なし）
  - Settings→ヘルスチェックで`/api/health`がOK
  - 終了時に子プロセス（Chainlit/Electron API）が停止
- 代表トラブルシュート
  - ポート競合: 8000/8001の使用プロセス停止
  - 依存不足: `uv pip install -r requirements.in`
  - 環境変数: `.env`の必須項目設定

### Phase 2: ポート外部化＋レスポンス正規化
- 目的: 環境でポート変更可能／UIとAPIのレスポンス差異を吸収
- 実装
  - `.env`: `CHAINLIT_PORT`, `ELECTRON_API_PORT` を導入
  - main.js / renderer / CSP(connect-src) を環境変数対応
  - レスポンス正規化（IPCで `{status,data}`→`{success,data}` に統一 or Rendererでフォールバック）
- UI確認
  - Personas/VectorStores/Analytics/Settings の操作一式
  - 任意ポート指定で起動・動作

### Phase 3: 起動/終了の堅牢化（リトライ・再起動・ログ保存）
- 実装
  - `waitForServers()` に最大リトライ/タイムアウト/再試行UI
  - `stop-*`→`start-*` をUIから操作可能に
  - ログ保存を実装（保存先: `<userData>/logs`）
    - main.log（Electron Main）
    - chainlit.out.log / chainlit.err.log（Chainlit子プロセス）
    - electron-api.out.log / electron-api.err.log（Electron API子プロセス）
  - 設定タブに「ログフォルダを開く」ボタンを追加（フォルダを開くだけ）
- UI確認
  - 起動失敗→再試行で復旧
  - ログファイルが生成・更新され、「ログフォルダを開く」でフォルダが開く

### Phase 4: python_dist 構築＋Windows packaged 検証
- 実装
  - `python_dist/` に `python.exe` + 必要site-packages（chainlit, fastapi, uvicorn, openai, python-dotenv 等）
  - `npm run build:win` でパッケージ生成
- 検証
  - 初回起動で `<userData>/.env` 生成（`.env.example`優先）
  - UIスモーク（Phase 1 同等）
  - 子プロセスの起動/終了、ログ出力を確認

### Phase 5: セキュリティ/設定最終調整（CSP）
- 実装: `unsafe-inline` の最小化、許可オリジンの限定
- 確認: コンソールにCSP違反が出ない、UI崩れが無い

## 実行コマンド
- 開発: `uv pip install -r requirements.in` → `npm i` → `npm run dev`
- 配布(Windows): `npm run build:win`

## 環境変数（サンプル）
- OPENAI_API_KEY, DEFAULT_MODEL
- CHAINLIT_AUTH_SECRET
- CHAINLIT_PORT=8000, ELECTRON_API_PORT=8001（Phase 2で導入）

## UIスモークの最小チェックリスト
- 画面表示: ローディング→メインUI
- チャット: Chainlit iframe表示/入力可能
- Personas: 一覧/作成/編集/削除（表示できない場合はAPIレスポンス整合性を確認）
- VectorStores: 一覧表示（空なら空表示）
- Analytics: 期間変更で表示更新
- Settings: `/api/health`, `/api/system/status`, `/api/system/logs` が成功
- 終了時: 子プロセス停止/ポート解放

## 変更履歴
| 日付 | バージョン | 変更内容 |
|------|------------|----------|
| 2025-09-09 | 4.0 | Option Bベースでフェーズ再定義、Windows配布に統一、.env初回生成方針を明記 |
| 2025-08-24 | 3.0 | Responses API最優先の方針（旧版をarchiveへ退避） |
