# 多機能AIワークスペース - 開発計画書（改訂版）

更新日: 2025年8月24日  
バージョン: 3.0  

## 🎯 **最重要事項：Responses API実装**

### 📌 **本プロジェクトの中核技術**
本プロジェクトは、OpenAIが2024年12月に発表した革新的な**Responses API**を基盤として構築されます。

**公式リファレンス：**
- [Responses API Quickstart](https://platform.openai.com/docs/quickstart?api-mode=responses)
- [新しいエージェント構築ツール（日本語）](https://openai.com/ja-JP/index/new-tools-for-building-agents/)
- [Web Search and States Example](https://cookbook.openai.com/examples/responses_api/responses_example)

Responses APIは、Chat Completions APIのシンプルさとAssistant APIのツール使用機能を組み合わせた、エージェント構築に特化した新しいAPIです。

### 🚫 **厳格な実装ルール**

**本プロジェクトでは：**
- ❌ **`client.chat.completions.create()`の使用を一切禁止**
- ✅ **`client.responses.create()`の使用を必須とする**
- 🔄 **既存のChat Completions API使用箇所は即座に書き換え**

```python
# ❌ 絶対に使用禁止
response = client.chat.completions.create(...)  # × コードレビューで差し戻し

# ✅ 必ず使用する
response = client.responses.create(...)  # ○ これが唯一許可される方法
```

## 開発方針
- **Small Start, Quick Feedback**: 各フェーズで動作確認を行い、問題があれば修正してから次へ進む
- **Incremental Development**: 機能を少しずつ追加し、常に動作する状態を維持
- **Test-Driven**: 各機能の実装後は必ず動作テストを実施

---

## ファイル作成の判断基準

### 作成OK ✅
- コード分割が必要な場合
- 将来の参照用メモ（明示的に要求された場合のみ）

### 作成NG ❌
- `setup.py`, `requirements.txt`（開発完了まで作成しない）
- 修正内容の詳細説明書
- プロジェクト管理系ファイル
- 「あった方が良い」程度の補助ファイル

**原則**: 現在は開発途中のため、必要最小限のファイル操作のみ行う

---

## 補助ファイル配置規則

| 種類 | 配置先 | 説明 |
|------|--------|------|
| 🔄 リファクタリングメモ | `docs/refactor_notes/` | コード改善計画やリファクタリング記録 |
| 📝 API仕様メモ | `docs/api_notes/` | OpenAI API仕様や使用方法のメモ |
| 🐛 バグ修正履歴 | `docs/bugfix_log/` | 発生したバグと修正内容の記録 |
| ⚙️ 設定例・参考 | `docs/config_examples/` | 設定ファイルのサンプルや参考情報 |
| 🗑️ 一時ファイル | `tmp/` | 作業用一時ファイル（作業後削除） |

**注意**: ディレクトリが存在しない場合は作成してから配置すること

---

## 実装済み機能（Phase 1-8） ✅

### Phase 1-3: 基本構成
- ✅ Chainlit起動確認
- ✅ 設定管理機能（`utils/config.py`）
- ✅ SQLite3データベース基盤（`data_layer.py`）
- ✅ 認証機能（`auth.py`）

### Phase 4-5: ❌ Chat Completions API実装（**使用禁止**）
- ⚠️ OpenAI Chat Completions API実装（**廃止予定**）
- ✅ ストリーミング対応
- ✅ セッション永続化（SQLite）
- ✅ 会話履歴管理
- ✅ タイトル自動生成
- **🔴 Chat Completions APIは即座に削除し、Responses APIに完全移行**

### Phase 6-8: 高度な機能
- ✅ モデル選択機能
- ✅ システムプロンプト設定
- ✅ ペルソナ管理（`utils/persona_manager.py`）
- ✅ ベクトルストア基本実装
- ✅ 3階層ベクトルストア（社内・個人・セッション）
- ✅ セキュアなベクトルストア管理

---

## 現在の課題と改善項目 🔄

### 優先度：最高 🔴🔴🔴
0. **Responses API実装（Chat Completions API使用禁止）**
   - 現在Chat Completions APIを使用中（**即座に停止必須**）
   - **Chat Completions APIの一切の使用を禁止**
   - **Responses APIへの完全移行が絶対条件**
   - `client.responses.create()`メソッドの実装（**唯一許可**）
   - Web Search機能のネイティブ統合
   - ステートフル会話管理の実装

### 優先度：高 🔴
1. **ベクトルストア実装の統合**
   - 複数のVSハンドラーが存在（統合が必要）
   - `vector_store_handler.py`
   - `vector_store_handler_v2.py`
   - `vector_store_handler_secure.py`
   - `secure_vector_store_manager.py`

2. **エラーハンドリングの強化**
   - WebSocket接続エラーの適切な処理
   - API呼び出しエラーのリトライ機構
   - ユーザーフレンドリーなエラーメッセージ

### 優先度：中 🟡
3. **UI/UXの改善**
   - サイドバーの機能整理
   - アクションボタンの配置最適化
   - レスポンシブデザインの改善

4. **パフォーマンス最適化**
   - 大規模ベクトルストアの検索速度
   - 会話履歴の読み込み速度
   - メモリ使用量の最適化

---

## 今後の実装予定 📋

### Phase 0: Responses API移行（最優先） 🚀
**目標**: Chat Completions APIを完全に排除し、Responses APIに統一

#### 実装内容
- **Chat Completions APIの完全削除**（最優先）
- `client.responses.create()`メソッドへの切り替え（**唯一許可される方法**）
- Web Search機能のネイティブ実装
- ステートフル会話管理
- File Search機能の最適化
- Code Interpreter統合
- **既存コードのchat.completions参照をすべて特定して削除**

#### 公式ドキュメント参照
```python
from openai import OpenAI
client = OpenAI()

response = client.responses.create(
    model="gpt-5",
    input="Write a one-sentence bedtime story about a unicorn.",
    tools=[
        {"type": "web_search", "enabled": True},
        {"type": "file_search", "file_search": {"vector_store_ids": ["vs_xxx"]}}
    ]
)

print(response.output_text)
```

#### 動作確認項目
- [ ] **Chat Completions APIの参照がゼロになったか**（最重要）
- [ ] Responses APIが正常に動作するか
- [ ] Web Search機能が利用できるか
- [ ] ステートフル会話が機能するか
- [ ] 既存機能との互換性が保たれるか
- [ ] コードレビューでChat Completions APIが検出されないか

---

### Phase 1: 画像処理機能（Responses API実装後）
**目標**: 画像のアップロードと分析機能

#### 実装内容
- 画像アップロード対応
- Vision APIの統合
- 画像付き会話の履歴管理

#### 動作確認項目
- [ ] 画像アップロードが正常に動作するか
- [ ] Vision APIで画像分析ができるか
- [ ] 画像付き会話が正しく保存されるか

---

### Phase 2: エクスポート機能
**目標**: チャット履歴を各種形式で出力

#### 実装内容
- JSON形式エクスポート
- Markdown形式エクスポート
- HTML形式エクスポート（スタイル付き）
- PDF形式エクスポート（オプション）

#### 動作確認項目
- [ ] 各形式でファイルが生成されるか
- [ ] 内容が正しく出力されているか
- [ ] 画像も含めてエクスポートできるか

---

### Phase 3: 高度な検索機能
**目標**: 会話履歴とベクトルストアの統合検索

#### 実装内容
- 会話履歴の全文検索
- タグベースの分類機能
- 日付範囲での絞り込み
- ベクトルストア横断検索

#### 動作確認項目
- [ ] キーワード検索が機能するか
- [ ] タグ付けと絞り込みができるか
- [ ] 複数のVSを横断して検索できるか

---

## 削除された項目 ❌

### ~~Phase 10: Agents SDK統合~~ → **削除**
**削除理由**:
- アプリの目的（対話型ワークスペース）に不適合
- 現在のTools API（Responses API）で十分な機能を実現
- 不必要な複雑性の増加を避ける
- メンテナンスコストの削減

---

## テスト項目チェックリスト

### 基本機能テスト ✅
- ✅ アプリケーションの起動
- ✅ APIキーの保存と読み込み
- ✅ 接続テストの成功/失敗
- ✅ 基本的なチャット機能
- ✅ メッセージの永続化
- ✅ セッションの切り替え

### 高度な機能テスト 🔄
- ✅ ベクトルストアの作成と削除
- ✅ 3階層VSの組み合わせ
- ⬜ 画像アップロード（未実装）
- ✅ ファイルアップロード
- ⬜ エクスポート機能（未実装）
- ⬜ 高度な検索機能（未実装）

### エラーハンドリングテスト 🔄
- 🔄 API接続エラー時の処理（改善中）
- ✅ 無効なファイル形式の処理
- 🔄 レート制限への対応（改善中）
- ✅ データベースエラーの処理

---

## 開発のポイント

### 🚫 **絶対遵守事項**

1. **Chat Completions APIの使用禁止**
   - `client.chat.completions.create()`は一切使用しない
   - 既存コードも発見次第削除
   - コードレビューで厳格にチェック

2. **Responses APIの必須使用**
   - `client.responses.create()`のみ使用許可
   - 公式ドキュメントに完全準拠
   - 他のAPIは一切使用しない

1. **コードの統合と整理を優先**
   - 重複した実装を統合
   - 未使用のコードを削除
   - 命名規則の統一

2. **ユーザビリティの向上**
   - エラーメッセージの改善
   - 操作フローの簡略化
   - ヘルプ機能の充実

3. **テスト駆動開発**
   - 単体テストの作成
   - 統合テストの実施
   - ユーザー受け入れテスト

4. **ドキュメントの整備**
   - APIドキュメントの更新
   - ユーザーマニュアルの作成
   - トラブルシューティングガイド

---

## 次のアクション 🎯

### 最優先タスク（Responses API移行）
0. **Responses API実装（Chat Completions API禁止）**
   - **Chat Completions APIの完全削除**（第一歩）
   - `utils/responses_handler.py`の全面改修
   - `client.responses.create()`への切り替え（**他の方法は許可しない**）
   - Web Search機能の実装
   - ステートフル会話管理の実装
   - 公式ドキュメントに準拠した実装
   - **コード全体から`chat.completions`をgrepして残存確認**

### その他の優先タスク
1. **ベクトルストア実装の統合**
   - 複数のVSハンドラーを1つに統合
   - 不要なコードの削除
   - テストの実施

2. **エラーハンドリングの改善**
   - WebSocketエラーの適切な処理
   - ユーザーフレンドリーなメッセージ

3. **UI/UXの最適化**
   - サイドバーの整理
   - アクションボタンの配置改善

### 中期目標
- Phase 9: 画像処理機能の実装
- Phase 10: エクスポート機能の実装
- Phase 11: 高度な検索機能の実装

---

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|------------|----------|
| 2025-08-24 | 3.0 | **Responses API実装を最優先事項として追加** |
| 2025-08-24 | 2.0 | 現状を反映した大幅改訂、Agents SDK削除 |
| 初版 | 1.0 | 初期計画書作成 |