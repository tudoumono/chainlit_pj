# Phase 6 動作確認

## 確認日時
2025-08-17

## 環境
- Python 3.11
- Chainlit
- OpenAI API
- SQLite データベース

## 動作確認手順

### 1. アプリケーション起動
```bash
# 仮想環境をアクティベート
.venv\Scripts\activate

# アプリケーションを起動
chainlit run app.py
# または
python run.py
```

### 2. ログイン
- ユーザー名: admin
- パスワード: admin123

### 3. ペルソナ機能の確認

#### 3.1 ペルソナ一覧の表示
```
コマンド: /persona
期待結果: デフォルトの5つのペルソナが表示される
```

#### 3.2 ペルソナの切り替え
```
コマンド: /persona プログラミング専門家
期待結果: 
- ペルソナが切り替わったことの確認メッセージ
- モデルがgpt-4oに変更
- Temperature が0.3に設定
```

#### 3.3 切り替え後の動作確認
```
メッセージ: Pythonでフィボナッチ数列を計算する関数を書いて
期待結果: 
- プログラミング専門家として詳細なコード説明
- 低いTemperature（0.3）による一貫性のある回答
```

#### 3.4 新しいペルソナの作成
```
コマンド: /persona create
手順:
1. 名前: テストペルソナ
2. 説明: テスト用のペルソナ
3. システムプロンプト: あなたはテスト用のAIアシスタントです
4. モデル: gpt-4o-mini
5. Temperature: 0.5
6. タグ: test, demo

期待結果: 新しいペルソナが作成される
```

#### 3.5 作成したペルソナへの切り替え
```
コマンド: /persona テストペルソナ
期待結果: 作成したペルソナに切り替わる
```

#### 3.6 ペルソナの削除
```
コマンド: /persona delete テストペルソナ
期待結果: ペルソナが削除される
```

#### 3.7 デフォルトペルソナの削除試行
```
コマンド: /persona delete 汎用アシスタント
期待結果: エラーメッセージ「デフォルトペルソナは削除できません」
```

### 4. システムプロンプトの確認

#### 4.1 手動設定
```
コマンド: /system あなたは必ず関西弁で話してください
メッセージ: こんにちは
期待結果: 関西弁での応答
```

#### 4.2 ペルソナのシステムプロンプト
```
コマンド: /persona クリエイティブライター
メッセージ: 短い詩を書いて
期待結果: 創造的な詩の生成（高Temperature 0.9）
```

### 5. モデル切り替えの確認

#### 5.1 モデル変更
```
コマンド: /model gpt-3.5-turbo
メッセージ: テストメッセージ
期待結果: gpt-3.5-turboからの応答
```

#### 5.2 ペルソナによるモデル設定
```
コマンド: /persona ビジネスアナリスト
期待結果: モデルがgpt-4oに自動変更
```

### 6. 永続化の確認

#### 6.1 カスタムペルソナの作成
```
コマンド: /persona create
[適当な設定で作成]
```

#### 6.2 アプリケーション再起動
```
Ctrl+C でアプリケーション停止
chainlit run app.py で再起動
```

#### 6.3 作成したペルソナの確認
```
コマンド: /persona
期待結果: 再起動前に作成したペルソナが残っている
```

## チェックリスト

### 基本機能
- [ ] ペルソナ一覧が表示される
- [ ] デフォルトペルソナが5つ存在する
- [ ] ペルソナの切り替えができる
- [ ] 新しいペルソナを作成できる
- [ ] カスタムペルソナを削除できる
- [ ] デフォルトペルソナは削除できない

### システムプロンプト
- [ ] ペルソナごとのシステムプロンプトが適用される
- [ ] 手動でシステムプロンプトを設定できる
- [ ] システムプロンプトがAIの応答に反映される

### モデル設定
- [ ] ペルソナごとのモデルが適用される
- [ ] 手動でモデルを変更できる
- [ ] モデル変更が応答に反映される

### Temperature設定
- [ ] ペルソナごとのTemperatureが適用される
- [ ] 低いTemperature（0.3）で一貫性のある応答
- [ ] 高いTemperature（0.9）で創造的な応答

### データ永続化
- [ ] アプリ再起動後もペルソナが保持される
- [ ] SQLiteデータベースに保存される
- [ ] アクティブなペルソナが記憶される

### エラーハンドリング
- [ ] 存在しないペルソナ名でエラーメッセージ
- [ ] 無効な入力値で適切な処理
- [ ] データベースエラー時のフォールバック

## トラブルシューティング

### ペルソナが表示されない
1. SQLiteデータベースの確認
   ```bash
   sqlite3 .chainlit/chainlit.db
   .tables
   SELECT * FROM personas;
   ```

2. data_layer.pyの確認
   - personasテーブルが作成されているか
   - 初期化処理が正しく実行されているか

### ペルソナが切り替わらない
1. セッション変数の確認
   - active_personaが更新されているか
   - system_promptが設定されているか

2. ログの確認
   ```python
   app_logger.debug("ペルソナ切り替え", persona=target_persona)
   ```

### システムプロンプトが効かない
1. responses_handler.pyの確認
   - system_promptがAPIに渡されているか
   - messagesの構築が正しいか

## まとめ

Phase 6の実装により、以下の機能が追加されました：
- ペルソナによる柔軟なAI設定管理
- 用途別の最適化されたAI応答
- インタラクティブな設定変更
- 永続的な設定保存

これにより、ユーザーは様々なシナリオに応じて最適なAI設定を簡単に切り替えることができるようになりました。
