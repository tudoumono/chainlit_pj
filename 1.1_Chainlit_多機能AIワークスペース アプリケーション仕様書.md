# **多機能AIワークスペース アプリケーション仕様書**

バージョン: 1.1  
作成日: 2025年8月6日  
概要: 本書は、OpenAIの最新API（Responses API, Agents SDK）を活用した、プロフェッショナル向けのデスクトップAIアプリケーションの技術仕様を定義するものである。

## **1\. 概要**

本アプリケーションは、単なるテキストチャットツールを超え、多様なワークフローを支援する多機能なAI作業環境を提供する。ユーザーは、GUIによる簡単な初期設定の後、2種類のAIエンジンを切り替えながら、テキスト、画像、ファイル、音声といったマルチモーダルな対話を行うことができる。

最大の特徴は、**社内・個人・セッションごと**という3階層のナレッジベース（ベクトルストア）を柔軟に組み合わせ、対話の文脈を動的に制御できる点にある。これにより、汎用的な応答から、専門的なドキュメントに基づいた高度な分析まで、幅広い用途に対応する。

## **2\. アーキテクチャとファイル構成**

保守性と拡張性を最優先し、**Chainlit**のマルチページアプリ機能と、役割ごとに明確に分離されたモジュール構造を採用する。

### **2.1. 全体構成**

.  
├── app.py \# ✅ 1\. アプリケーションの入口 (ウェルカム/設定画面)  
├── pages/  
│ ├── 1\_Responses\_API\_Chat.py \# ✅ 2\. Responses API版チャット画面  
│ └── 2\_Agents\_SDK\_Chat.py \# ✅ 3\. Agents SDK版チャット画面  
├── utils/  
│ ├── config.py \# ✅ 4\. 設定管理 (.envの読み書き、接続テスト)  
│ ├── session\_handler.py \# ✅ 5\. DB管理 (SQLiteによる永続化)  
│ ├── vector\_store\_handler.py \# ✅ 6\. OpenAI Embeddingsベクトルストア管理  
│ ├── response\_handler.py \# ✅ 7\. Responses APIのロジック  
│ ├── agent\_handler.py \# ✅ 8\. Agents SDKのロジック  
│ └── export\_handler.py \# ✅ 9\. 履歴エクスポート処理  
├── .env \# ユーザー固有の設定ファイル (APIキーなど)  
├── requirements.txt \# Pythonの依存ライブラリ  
└── README.md \# 簡易的な説明書

### **2.2. 各ファイルの役割**

1. **app.py**: **ウェルカム・設定画面**。ユーザーが最初にアクセスするページ。APIキー/プロキシ/共有VS IDの設定と接続テストを行い、ここから各チャットページへ分岐させる。  
2. **pages/1\_...**: **Responses API版チャット画面**。OpenAIのResponses APIを直接利用し、previous\_response\_idで状態を管理する。APIの低レベルな動作を制御し、ストリーミングイベントを詳細に処理する。  
3. **pages/2\_...**: **Agents SDK版チャット画面**。高レベルなAgents SDKを利用し、thread\_idで状態を管理する。APIとの複雑なやり取りが抽象化されている。  
4. **utils/config.py**: **設定管理モジュール**。.envファイルの操作（読み込み・保存）と、OpenAI APIへの接続診断ロジックを集約。  
5. **utils/session\_handler.py**: **データベース管理モジュール**。**SQLite3**を操作し、全てのセッション情報、メッセージ履歴、ペルソナ設定などを永続化する。  
6. **utils/vector\_store\_handler.py**: **ベクトルストア管理モジュール**。**OpenAI Embeddings**を使用して、OpenAIのサーバー上に、個人用およびセッション用（一時的）のベクトルストアを作成・削除・管理する。  
7. **utils/response\_handler.py**: **Responses API補助モジュール**。Responses APIを呼び出すためのリクエスト構築や、モデルリスト取得、タイトル自動生成などを行う。  
8. **utils/agent\_handler.py**: **Agents SDK補助モジュール**。Agents SDKのエージェント定義や設定を行う。  
9. **utils/export\_handler.py**: **エクスポート処理モジュール**。チャット履歴をJSON, HTML, PDF形式に変換するロジックを担う。

## **3\. 主要機能仕様**

### **3.1. ウェルカム画面 (app.py)**

* **機能**: アプリケーションの健全性を確認し、ユーザーの利用準備を整える。  
* **要件**:  
  * GUI上でAPIキー、プロキシ、社内共有VS IDの入力と保存が可能であること。  
  * 保存された設定は.envファイルに書き込まれること。  
  * 「接続テスト」ボタンにより、APIキーの有効性とネットワーク接続性を診断し、結果を分かりやすく表示すること。  
  * 接続テストが成功した場合のみ、サイドバーに各チャットページへのリンクが表示されること。

### **3.2. デュアルチャットエンジン (pages/\*.py)**

* **機能**: 特性の異なる2種類のAPIインターフェースを提供し、ユーザーが用途に応じて選択できるようにする。  
* **要件**:  
  * **Responses API版**: previous\_response\_idを用いて会話を継続する。APIからのストリーミングイベント（response.delta, response.tool\_delta等）を個別に処理し、UIに反映する。  
  * **Agents SDK版**: thread\_idを用いて会話を継続する。SDKのstream\_runメソッドを利用し、抽象化されたイベントを処理する。エージェントの思考プロセス（ツール呼び出し等）を可視化する。

### **3.3. 高度なベクトルストア管理**

* **機能**: 複数のナレッジベースを動的に組み合わせて、AIの応答精度と文脈理解能力を向上させる。  
* **要件**:  
  * **3階層のベクトルストア**:  
    1. **社内ナレッジ (共有)**: .envでIDを指定。読み取り専用。  
    2. **個人ナレッジ**: ユーザーがGUIでファイル群をアップロードし、作成・削除できる。IDはローカルに保存。  
    3. **セッションナレッジ (一時的)**: チャット入力欄から添付されたファイルでその場限りのVSを生成。セッション終了時に破棄されることが望ましい。  
  * **動的な組み合わせ**: サイドバーのチェックボックスで「社内」「個人」の利用を切り替え可能であること。API呼び出し時に、有効なVS IDのリストをtool\_resourcesとして動的に構築して渡すこと。  
  * **OpenAI Embeddingsの使用**: ベクトルストアの作成、管理、検索には**OpenAI Embeddings**を使用する。

\# response\_handler.py での実装イメージ  
def get\_response\_stream(...):  
    \# ...  
    tool\_resources \= {}  
    if vs\_ids\_to\_use: \# \[社内ID, 個人ID, セッションID\] のようなリスト  
        tool\_resources\["file\_search"\] \= {"vector\_store\_ids": vs\_ids\_to\_use}  
    \# ...

### **3.4. マルチモーダル入力**

* **機能**: テキストに加え、画像や各種ファイルをプロンプトとして利用できるようにする。  
* **要件**:  
  * チャット入力欄にファイルアップローダーを設置すること。  
  * 添付されたファイルの種類（画像かその他か）を判別すること。  
  * 画像ファイルはBase64エンコードし、"type": "image\_url"としてプロンプトに含めること。  
  * その他ファイルはpurpose='vision'でOpenAIにアップロードし、そのファイルIDを"type": "image\_file"としてプロンプトに含めること。  
  * 最終的に、prompt: {"content": \[...\]} のリスト形式でAPIに送信すること。

### **3.5. 永続化と状態管理**

* **機能**: アプリケーションを再起動しても、過去の対話や設定が失われないようにする。  
* **要件**:  
  * **SQLite3**データベース（chat\_history.db）を使用する。  
  * **chat\_sessions Table**: 各チャットセッションのメタ情報（タイトル、利用モデル、VS設定、タグ、最後の応答ID/スレッドIDなど）を管理する。  
  * **chat\_messages Table**: 各メッセージの内容（JSON形式）とトークン数を保存する。  
  * **personas Table**: ユーザーが作成したペルソナ設定を保存する。  
  * **Chainlit**のsession\_stateを揮発性の状態保持に、**SQLite3**を永続的な状態保持に使い分けること。

## **4\. データベース設計**

**chat\_history.db (SQLite3)**

* **chat\_sessions Table**  
  * id (TEXT, PRIMARY KEY): UUID  
  * title (TEXT): AIが自動生成したタイトル  
  * chat\_type (TEXT): "responses" or "agent"  
  * model (TEXT): 使用モデル名 (e.g., "gpt-4o")  
  * system\_prompt (TEXT): 指示内容  
  * thread\_or\_response\_id (TEXT): 会話継続用のID  
  * session\_vs\_id (TEXT): セッション用VSのID  
  * use\_company\_vs (BOOLEAN): 社内VS利用フラグ  
  * use\_personal\_vs (BOOLEAN): 個人VS利用フラグ  
  * tags (TEXT): カンマ区切りのタグ文字列  
  * created\_at (TIMESTAMP)  
* **chat\_messages Table**  
  * id (INTEGER, PRIMARY KEY): 自動採番  
  * session\_id (TEXT, FOREIGN KEY)  
  * message\_json (TEXT): メッセージオブジェクト全体のJSON文字列  
  * token\_usage (TEXT): トークン情報のJSON文字列  
* **personas Table**  
  * id (INTEGER, PRIMARY KEY): 自動採番  
  * name (TEXT, UNIQUE): ペルソナ名  
  * model (TEXT)  
  * system\_prompt (TEXT)

## **5\. セットアップと実行**

1. **依存関係のインストール**: pip install \-r requirements.txt  
2. **起動**: chainlit run app.py  
3. **初回設定**: 起動したGUIでAPIキー等を設定し、接続テストを実行する。

## **6\. 参考資料 (Reference Materials)**

本アプリケーションのコア機能は、以下の公式ドキュメントに基づいています。将来のメンテナンスや機能拡張の際には、これらの一次情報を参照してください。

* [**Responses API \- Quickstart**](https://platform.openai.com/docs/quickstart?api-mode=responses)  
  * Responses APIの基本的な使い方とコンセプトを理解するための入門ガイド。  
* [**Responses API \- API Reference**](https://platform.openai.com/docs/api-reference/responses)  
  * client.responses.createメソッドの詳細なパラメータやレスポンス形式を定義した公式リファレンス。  
* [**Streaming Responses \- Guide**](https://platform.openai.com/docs/guides/streaming-responses?api-mode=responses)  
  * Responses APIにおけるイベントベースのストリーミング処理方法に関する詳細なガイド。  
* [**Agents SDK \- GitHub Repository**](https://openai.github.io/openai-agents-python/)  
  * Agents SDKの公式ドキュメント。エージェントの定義や実行方法について解説。  
* [**OpenAI Embeddings Guide**](https://platform.openai.com/docs/guides/embeddings)  
  * OpenAI Embeddingsの利用方法に関する公式ガイド。ベクトルストアの構築と検索に不可欠な情報。