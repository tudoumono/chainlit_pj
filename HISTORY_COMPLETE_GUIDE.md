# Chainlit履歴復元の完全実装ガイド

## 実装完了した機能

1. ✅ **履歴の表示**: 過去の会話リストが正しく表示される
2. ✅ **履歴の名前変更**: 会話の名前を変更できる  
3. ✅ **履歴の保存**: スレッドとステップが正しく保存される
4. ✅ **空のスレッド対策**: ユーザーメッセージがある場合のみスレッド作成
5. ✅ **履歴の復元**: 過去のメッセージを画面に再表示

## 履歴復元の仕組み

### 1. データ保存の流れ
```
ユーザーメッセージ送信
    ↓
create_step（type: user_message）
    ↓
スレッドが存在しない場合は自動作成
    ↓
AIの処理（type: run）
    ↓
AIの回答（type: assistant_message）
```

### 2. 履歴復元の流れ
```
履歴ボタンクリック
    ↓
過去の会話を選択
    ↓
on_chat_resumeハンドラー呼び出し
    ↓
get_threadでスレッドとステップを取得
    ↓
ステップから各メッセージを再構築
    ↓
画面に順番に表示
```

## メッセージの復元処理

`on_chat_resume`では以下の処理を実行：

1. **ステップの取得**: thread['steps']から全ステップを取得
2. **メッセージの抽出**:
   - `user_message`: inputフィールドからユーザーの入力を取得
   - `assistant_message`: outputフィールドからAIの回答を取得
   - `run`: システム的な処理なのでスキップ（または必要に応じて表示）
3. **順次表示**: 元のIDを保持しながらメッセージを画面に表示

## 使用方法

### 1. アプリケーションの起動
```bash
chainlit run app.py --headless
```

### 2. 会話の実施
1. メッセージを送信してAIと会話
2. 複数のやり取りを行う

### 3. 履歴の確認
1. 左上の履歴ボタンをクリック
2. 過去の会話リストが表示される
3. 復元したい会話をクリック

### 4. 履歴の復元
- 選択した会話の全メッセージが画面に表示される
- ユーザーメッセージとAIの回答が正しい順序で再現される

## デバッグツール

### ステップの詳細確認
```bash
python check_step_details.py
```
最新スレッドのステップ内容を詳細に表示

### get_threadメソッドのテスト
```bash
python test_get_thread.py
```
get_threadが正しくデータを返すか確認

### データベースの診断
```bash
python check_restore_issue.py
```
スレッドとステップの整合性を確認

### 不要データのクリーンアップ
```bash
python cleanup_db.py
```
空のスレッドや孤立したステップを削除

## トラブルシューティング

### 履歴が表示されない場合
- ユーザーがメッセージを送信したか確認
- データベースファイル（.chainlit/chainlit.db）が存在するか確認

### 復元時にメッセージが表示されない場合
- `check_step_details.py`でステップの内容を確認
- inputとoutputフィールドにデータが保存されているか確認

### 復元時の表示順序がおかしい場合
- ステップのcreated_atフィールドで並び替えられているか確認
- データベースのタイムスタンプが正しいか確認

## 技術的な詳細

### ステップタイプと保存フィールド

| タイプ | 保存フィールド | 用途 |
|--------|--------------|------|
| user_message | input | ユーザーの入力テキスト |
| assistant_message | output | AIの回答テキスト |
| run | output（通常JSON） | 処理の記録 |

### 重要なメソッド

#### data_layer.py
- `create_step`: ステップを保存（スレッド自動作成機能付き）
- `get_thread`: スレッドとステップを取得
- `get_thread_steps`: ステップのみを取得

#### app.py
- `on_chat_resume`: 履歴復元時の処理
- メッセージの再構築と表示

## 期待される動作

### 新規チャット時
```
👤 現在のユーザー: User(identifier='admin', ...)
🔧 SQLite: create_stepが呼ばれました - Type: user_message
   ⚠️ スレッドが存在しません。自動作成します
   ✅ スレッドをSQLiteに保存しました
   ✅ ステップをSQLiteに保存しました
```

### 履歴復元時
```
📂 on_chat_resumeが呼ばれました
   Thread ID: xxx
   Thread Name: Chat 2025-08-13 09:52
   Steps count: 5
   📥 ユーザーメッセージを準備: こんにちは...
   🤖 アシスタントメッセージを準備: こんにちは！...
   ✅ 復元完了: 2件のメッセージ
```

## まとめ

履歴機能が完全に実装されました：
- 会話の保存と表示
- 名前の変更
- 過去の会話の完全復元（メッセージの再表示）
- デバッグツールによる問題診断

アプリケーションを再起動して、履歴復元機能をお試しください！
